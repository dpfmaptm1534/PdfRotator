<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>PDF íšŒì „ê¸°</title>

    <!-- ì•ˆì •ëœ PDF.js ë²„ì „ ì‚¬ìš© -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script>
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';
    </script>

    <style>
        canvas {
            border: 1px solid #ccc;
            margin-top: 10px;
            display: block;
            width: 200px;
        }

        #loadingStatus {
            margin-top: 10px;
            font-weight: bold;
            color: #0066cc;
        }
    </style>
</head>
<body>
    <h2>PDF íšŒì „ ë„êµ¬</h2>

    <form id="pdfForm" method="post" enctype="multipart/form-data">
        <input type="file" id="pdfFile" name="pdf" accept="application/pdf" required>
        <br><br>
        <button type="button" onclick="rotate(-90)">âŸ² ì™¼ìª½ 90Â°</button>
        <button type="button" onclick="rotate(90)">âŸ³ ì˜¤ë¥¸ìª½ 90Â°</button>
        <button type="button" onclick="submitPDF()">íšŒì „ëœ PDF ë‹¤ìš´ë¡œë“œ</button>
    </form>

    <p id="loadingStatus">PDF íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</p>
    <canvas id="pdfCanvas"></canvas>

    <script>
        let pdfDoc = null;
        let currentPage = null;
        let rotation = 0;
        let fakeProgressInterval;

        document.getElementById('pdfFile').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('loadingStatus').innerText = 'PDF ë¡œë”© ì¤‘...';

                const fileReader = new FileReader();
                fileReader.onload = function () {
                    const typedarray = new Uint8Array(this.result);

                    pdfjsLib.getDocument({
                        data: typedarray,
                        onProgress: function (progressData) {
                            const percent = Math.round(progressData.loaded / progressData.total * 100);
                            document.getElementById('loadingStatus').innerText = `PDF ë¡œë”© ì¤‘... ${percent}%`;
                        }
                    }).promise.then(function (pdf) {
                        pdfDoc = pdf;
                        pdfDoc.getPage(1).then(function (page) {
                            currentPage = page;
                            renderPage();
                            document.getElementById('loadingStatus').innerText = 'PDF ë¡œë”© ì™„ë£Œ!';
                        });
                    }).catch(function (err) {
                        document.getElementById('loadingStatus').innerText = 'PDF ë¡œë”© ì‹¤íŒ¨';
                        console.error(err);
                    });
                };
                fileReader.readAsArrayBuffer(file);
            }
        });

        function renderPage() {
            const canvas = document.getElementById('pdfCanvas');
            const context = canvas.getContext('2d');
            const viewport = currentPage.getViewport({ scale: 1.5, rotation: rotation });

            canvas.width = viewport.width;
            canvas.height = viewport.height;

            const renderContext = {
                canvasContext: context,
                viewport: viewport
            };
            currentPage.render(renderContext);
        }

        function rotate(degrees) {
            if (!currentPage) {
                alert("ë¨¼ì € PDFë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”!");
                return;
            }
            rotation = (rotation + degrees + 360) % 360;
            renderPage();
        }

        function submitPDF() {
            const fileInput = document.getElementById('pdfFile');
            if (!fileInput.files.length) {
                alert('PDF íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.');
                return;
            }

            // âœ… ì§„í–‰ë¥  ì´ˆê¸°í™”
            let fakePercent = 0;
            const loadingText = document.getElementById('loadingStatus');
            loadingText.innerText = 'PDF ë³€í™˜ ì¤‘... 0%';

            // âœ… í˜ì´í¬ í¼ì„¼íŠ¸ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
            fakeProgressInterval = setInterval(() => {
                if (fakePercent < 90) {
                    fakePercent++;
                    loadingText.innerText = `PDF ë³€í™˜ ì¤‘... ${fakePercent}%`;
                }
            }, 50);

            const formData = new FormData();
            formData.append('pdf', fileInput.files[0]);
            formData.append('direction', rotation);

            fetch('/rotate', {
                method: 'POST',
                body: formData
            }).then(response => response.blob())
              .then(blob => {
                  clearInterval(fakeProgressInterval);  // ì• ë‹ˆë©”ì´ì…˜ ì¤‘ë‹¨
                  loadingText.innerText = 'PDF ë³€í™˜ ì¤‘... 100%';

                  const url = window.URL.createObjectURL(blob);
                  const a = document.createElement('a');
                  a.href = url;
                  a.download = 'rotated.pdf';
                  document.body.appendChild(a);
                  a.click();
                  a.remove();

                  setTimeout(() => {
                      loadingText.innerText = 'PDF ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!';
                  }, 1000);
              })
              .catch(err => {
                  clearInterval(fakeProgressInterval);
                  loadingText.innerText = 'PDF ë³€í™˜ ì¤‘ ì˜¤ë¥˜ ë°œìƒ ğŸ˜¢';
                  console.error(err);
              });
        }
    </script>
</body>
</html>
